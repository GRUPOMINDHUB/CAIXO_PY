{% extends 'base.html' %}
{% load currency %}

{% block title %}Proje√ß√µes - Caix√¥{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Cabe√ßalho com Filtro de Per√≠odo -->
    <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border); border-top: 3px solid #D4AF37;">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold mb-2" style="color: var(--caixo-text-primary);">Proje√ß√µes Financeiras</h1>
                <p class="text-sm" style="color: var(--caixo-text-secondary);">
                    {% if period_filter == 'custom' and date_start and date_end %}
                        Per√≠odo: {{ date_start|date:"d/m/Y" }} a {{ date_end|date:"d/m/Y" }}
                    {% elif period_filter == 'today' %}
                        Hoje
                    {% elif period_filter == '7_days' %}
                        Pr√≥ximos 7 dias
                    {% elif period_filter == '15_days' %}
                        Pr√≥ximos 15 dias
                    {% elif period_filter == 'next_month' %}
                        M√™s que vem
                    {% else %}
                        Pr√≥ximos 7 dias
                    {% endif %}
                </p>
            </div>
            
            <!-- Filtro de Per√≠odo -->
            <div class="flex flex-wrap gap-2">
                <a href="?period=today" 
                   class="px-4 py-2 rounded-lg text-sm font-medium transition {% if period_filter == 'today' %}{% else %}hover:opacity-90{% endif %}"
                   style="{% if period_filter == 'today' %}background-color: #D4AF37; color: #000000;{% else %}background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);{% endif %}">
                    Hoje
                </a>
                <a href="?period=7_days" 
                   class="px-4 py-2 rounded-lg text-sm font-medium transition {% if period_filter == '7_days' %}{% else %}hover:opacity-90{% endif %}"
                   style="{% if period_filter == '7_days' %}background-color: #D4AF37; color: #000000;{% else %}background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);{% endif %}">
                    7 Dias
                </a>
                <a href="?period=15_days" 
                   class="px-4 py-2 rounded-lg text-sm font-medium transition {% if period_filter == '15_days' %}{% else %}hover:opacity-90{% endif %}"
                   style="{% if period_filter == '15_days' %}background-color: #D4AF37; color: #000000;{% else %}background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);{% endif %}">
                    15 Dias
                </a>
                <a href="?period=next_month" 
                   class="px-4 py-2 rounded-lg text-sm font-medium transition {% if period_filter == 'next_month' %}{% else %}hover:opacity-90{% endif %}"
                   style="{% if period_filter == 'next_month' %}background-color: #D4AF37; color: #000000;{% else %}background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);{% endif %}">
                    M√™s Que Vem
                </a>
                <button onclick="openCustomPeriodModal()" 
                        class="px-4 py-2 rounded-lg text-sm font-medium transition hover:opacity-90"
                        style="{% if period_filter == 'custom' %}background-color: #D4AF37; color: #000000;{% else %}background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);{% endif %}">
                    Personalizado
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Per√≠odo Personalizado -->
    <div id="customPeriodModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="rounded-lg p-6 max-w-md w-full mx-4" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
            <h2 class="text-xl font-bold mb-4" style="color: var(--caixo-text-primary);">Per√≠odo Personalizado</h2>
            <form method="get" action="{% url 'projections' %}" class="space-y-4">
                <input type="hidden" name="period" value="custom">
                
                <div>
                    <label for="date_start" class="block text-sm font-medium mb-2" style="color: var(--caixo-text-primary);">Data Inicial</label>
                    <input type="date" 
                           id="date_start" 
                           name="date_start" 
                           value="{{ date_start|default:'' }}"
                           required
                           class="w-full px-4 py-2 rounded-lg outline-none transition"
                           style="border: 1px solid var(--caixo-border); color: var(--caixo-text-primary); background-color: var(--caixo-bg-card);">
                </div>
                
                <div>
                    <label for="date_end" class="block text-sm font-medium mb-2" style="color: var(--caixo-text-primary);">Data Final</label>
                    <input type="date" 
                           id="date_end" 
                           name="date_end" 
                           value="{{ date_end|default:'' }}"
                           required
                           class="w-full px-4 py-2 rounded-lg outline-none transition"
                           style="border: 1px solid var(--caixo-border); color: var(--caixo-text-primary); background-color: var(--caixo-bg-card);">
                </div>
                
                <div class="flex gap-3 justify-end">
                    <button type="button" 
                            onclick="closeCustomPeriodModal()"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition hover:opacity-90"
                            style="background-color: var(--caixo-bg-primary); border: 1px solid var(--caixo-border); color: var(--caixo-text-primary);">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 rounded-lg text-sm font-medium transition hover:opacity-90 btn-action-primary"
                            style="background-color: #D4AF37; color: #000000;">
                        Aplicar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mensagem de Erro -->
    {% if error %}
    <div class="px-4 py-3 rounded-lg border" style="background-color: #FDF2F2; border-color: #E67E22; color: #E67E22;">
        {{ error }}
    </div>
    {% endif %}

    <!-- Cards Superiores: Financeiro, Clima e Eventos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
        <!-- Card 1: Saldo Projetado -->
        <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium" style="color: var(--caixo-text-secondary);">Saldo Projetado</h3>
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: {% if saldo_previsto >= 0 %}#27AE60{% else %}#E67E22{% endif %>;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <p class="text-2xl lg:text-3xl font-bold" style="color: {% if saldo_previsto >= 0 %}#27AE60{% else %}#E67E22{% endif %>;">
                R$ {{ saldo_previsto|currency_br }}
            </p>
            <p class="text-xs mt-2" style="color: var(--caixo-text-secondary);">
                Saldo Atual: R$ {{ saldo_atual|currency_br }} | 
                + Receitas: R$ {{ receitas_projetadas|currency_br }} | 
                - Despesas: R$ {{ despesas_projetadas|currency_br }}
            </p>
            {% if saldo_previsto < 0 %}
            <div class="mt-3 px-3 py-2 rounded-lg" style="background-color: rgba(230, 126, 34, 0.1); border: 1px solid #E67E22;">
                <p class="text-xs font-medium" style="color: #E67E22;">‚ö†Ô∏è Aten√ß√£o: Saldo ficar√° negativo!</p>
            </div>
            {% endif %}
        </div>

        <!-- Card 2: Clima -->
        <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
            <h3 class="text-sm font-medium mb-4" style="color: var(--caixo-text-secondary);">Previs√£o do Tempo</h3>
            {% if weather_data.error %}
            <p class="text-xs" style="color: var(--caixo-text-secondary);">{{ weather_data.error }}</p>
            {% endif %}
            {% if not weather_data.error and weather_data.forecast %}
            <div class="space-y-2">
                {% for forecast in weather_data.forecast|slice:":5" %}
                <div class="flex items-center justify-between text-xs">
                    <span style="color: var(--caixo-text-secondary);">{{ forecast.date|date:"d/m" }}</span>
                    <span style="color: var(--caixo-text-primary);">
                        {% if forecast.main == 'Rain' %}üåßÔ∏è{% elif forecast.main == 'Clear' %}‚òÄÔ∏è{% elif forecast.main == 'Clouds' %}‚òÅÔ∏è{% else %}üå§Ô∏è{% endif %}
                        {{ forecast.description|capfirst }}
                    </span>
                    <span style="color: var(--caixo-text-secondary);">{{ forecast.temp|floatformat:0 }}¬∞C</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% if not weather_data.error and weather_data.alerts %}
            <div class="mt-3 space-y-1">
                {% for alert in weather_data.alerts %}
                <div class="px-3 py-2 rounded-lg text-xs" style="background-color: rgba(230, 126, 34, 0.1); border: 1px solid #E67E22;">
                    <p style="color: #E67E22;">‚ö†Ô∏è {{ alert.message }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% if not weather_data.error and not weather_data.forecast and not weather_data.alerts %}
            <p class="text-xs" style="color: var(--caixo-text-secondary);">Configure cidade e bairro da empresa para ver previs√£o.</p>
            {% endif %}
        </div>

        <!-- Card 3: Eventos e Feriados -->
        <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
            <h3 class="text-sm font-medium mb-4" style="color: var(--caixo-text-secondary);">Eventos e Feriados</h3>
            <div class="space-y-2 max-h-48 overflow-y-auto">
                {% for holiday in holidays_list %}
                <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--caixo-text-secondary);">üìÖ {{ holiday.date|date:"d/m" }}</span>
                    <span style="color: var(--caixo-text-primary);">{{ holiday.name }}</span>
                </div>
                {% endfor %}
                {% for event in events_list %}
                <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--caixo-text-secondary);">üéâ {{ event.date|date:"d/m" }}</span>
                    <div>
                        <span style="color: var(--caixo-text-primary); font-medium;">{{ event.name }}</span>
                        {% if event.description %}
                        <p class="text-xs mt-0.5" style="color: var(--caixo-text-secondary);">{{ event.description }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not holidays_list and not events_list %}
                <p class="text-xs" style="color: var(--caixo-text-secondary);">Nenhum evento ou feriado no per√≠odo.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Escada Financeira -->
    <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
        <h2 class="text-lg font-bold mb-4" style="color: var(--caixo-text-primary);">Escada Financeira (Proje√ß√£o Dia a Dia)</h2>
        {% if escada_financeira %}
        <div class="overflow-x-auto">
            <div class="min-w-full">
                <!-- Barras horizontais representando o saldo dia a dia -->
                <div class="space-y-2">
                    {% for dia in escada_financeira %}
                    <div class="flex items-center gap-4">
                        <div class="w-24 text-xs font-medium" style="color: var(--caixo-text-secondary);">
                            {{ dia.date|date:"d/m/Y" }}
                        </div>
                        <div class="flex-1 relative h-8 rounded-lg overflow-hidden" style="background-color: var(--caixo-bg-primary);">
                            <div class="absolute inset-y-0 left-0 right-0 flex items-center justify-between px-3">
                                <span class="text-xs font-medium" style="color: var(--caixo-text-secondary);">
                                    {% if dia.expense > 0 %}üí∏ -R$ {{ dia.expense|currency_br }} {% endif %}
                                    {% if dia.revenue > 0 %}üí∞ +R$ {{ dia.revenue|currency_br }}{% endif %}
                                </span>
                                <span class="text-xs font-bold" style="color: {% if dia.balance >= 0 %}#27AE60{% else %}#E67E22{% endif %};">
                                    R$ {{ dia.balance|currency_br }}
                                </span>
                            </div>
                            <!-- Barra de saldo (usando JavaScript para c√°lculo din√¢mico) -->
                            <div class="absolute inset-y-0 left-0 h-full transition-all duration-300 bar-saldo" 
                                 data-balance="{{ dia.balance }}"
                                 data-min-balance="{{ saldo_atual }}"
                                 data-max-balance="{{ saldo_previsto }}"
                                 style="background-color: {% if dia.balance >= 0 %}rgba(39, 174, 96, 0.3){% else %}rgba(230, 126, 34, 0.3){% endif %};">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-center py-8 text-sm" style="color: var(--caixo-text-secondary);">Nenhuma movimenta√ß√£o projetada para o per√≠odo.</p>
        {% endif %}
    </div>

    <!-- Tabela: O que vem por a√≠ (Maiores Despesas) -->
    <div class="rounded-lg shadow-sm p-4 lg:p-6" style="background-color: var(--caixo-bg-card); border: 1px solid var(--caixo-border);">
        <h2 class="text-lg font-bold mb-4" style="color: var(--caixo-text-primary);">O que vem por a√≠ - Maiores Despesas</h2>
        {% if maiores_despesas %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y" style="border-color: var(--caixo-border);">
                <thead style="background-color: var(--caixo-bg-primary);">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase" style="color: var(--caixo-text-secondary); border-bottom: 1px solid var(--caixo-border);">Vencimento</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase" style="color: var(--caixo-text-secondary); border-bottom: 1px solid var(--caixo-border);">Descri√ß√£o</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase" style="color: var(--caixo-text-secondary); border-bottom: 1px solid var(--caixo-border);">Categoria</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase" style="color: var(--caixo-text-secondary); border-bottom: 1px solid var(--caixo-border);">Valor</th>
                    </tr>
                </thead>
                <tbody class="divide-y" style="border-color: var(--caixo-border);">
                    {% for installment in maiores_despesas %}
                    <tr class="hover:opacity-80 transition">
                        <td class="px-4 py-3 text-sm" style="color: var(--caixo-text-primary);">
                            {{ installment.due_date|date:"d/m/Y" }}
                        </td>
                        <td class="px-4 py-3 text-sm" style="color: var(--caixo-text-primary);">
                            {{ installment.transaction.description|default:"‚Äî"|truncatewords:10 }}
                        </td>
                        <td class="px-4 py-3 text-sm" style="color: var(--caixo-text-secondary);">
                            {% if installment.transaction.subcategory %}
                                {{ installment.transaction.subcategory.name }}
                            {% elif installment.transaction.category %}
                                {{ installment.transaction.category.name }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-semibold" style="color: #E67E22;">
                            R$ {{ installment.amount|currency_br }}
                            {% if installment.penalty_amount > 0 %}
                                <div class="text-xs" style="color: var(--caixo-text-secondary);">
                                    + Multa: R$ {{ installment.penalty_amount|currency_br }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center py-8 text-sm" style="color: var(--caixo-text-secondary);">Nenhuma despesa projetada para o per√≠odo.</p>
        {% endif %}
    </div>
</div>

{% endblock content %}

<script>
    function openCustomPeriodModal() {
        document.getElementById('customPeriodModal').classList.remove('hidden');
        document.getElementById('customPeriodModal').classList.add('flex');
    }
    
    function closeCustomPeriodModal() {
        document.getElementById('customPeriodModal').classList.add('hidden');
        document.getElementById('customPeriodModal').classList.remove('flex');
    }
    
    // Fecha modal ao clicar fora
    document.getElementById('customPeriodModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCustomPeriodModal();
        }
    });
    
    // Calcula largura das barras da escada financeira
    document.addEventListener('DOMContentLoaded', function() {
        const bars = document.querySelectorAll('.bar-saldo');
        if (bars.length === 0) return;
        
        // Encontra valores m√≠nimo e m√°ximo de todos os dias
        let minBalance = Infinity;
        let maxBalance = -Infinity;
        
        bars.forEach(bar => {
            const balance = parseFloat(bar.dataset.balance);
            if (balance < minBalance) minBalance = balance;
            if (balance > maxBalance) maxBalance = balance;
        });
        
        // Ajusta para incluir zero se necess√°rio
        if (minBalance > 0) minBalance = 0;
        if (maxBalance < 0) maxBalance = 0;
        
        const range = maxBalance - minBalance;
        
        // Calcula largura de cada barra
        bars.forEach(bar => {
            const balance = parseFloat(bar.dataset.balance);
            // Normaliza o valor para o range
            const normalized = range > 0 ? ((balance - minBalance) / range) * 100 : 50;
            bar.style.width = Math.max(5, Math.min(100, normalized)) + '%';
        });
    });
</script>
